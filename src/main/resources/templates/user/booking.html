<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sportplex | Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
	
	<style>
		.slot-container {
		        display: flex;
		        flex-wrap: wrap;
		        gap: 15px;
		    }

		    .slot-card {
		        width: 180px;
		        padding: 15px;
		        border-radius: 8px;
		        text-align: center;
		        cursor: pointer;
		        background: #f5f5f5;
		        border: 2px solid transparent;
		        transition: 0.3s;
		    }

		    .slot-card.available {
		        border-color: green;
		        background: #e8ffe8;
		    }

		    .slot-card.booked {
		        border-color: red;
		        background: #ffe8e8;
		        cursor: not-allowed;
		    }

		    .slot-card:hover {
		        transform: scale(1.05);
		    }

		    .slot-card.selected {
		        border-color: blue !important;
		        background: #d0e8ff !important;
		    }
	</style>
</head>
<body>
    <div class="container mt-4">
        <h2>Book a Slot</h2>
        
        <form id="bookingForm" th:action="@{/create}" method="POST">
            <!-- Hidden Inputs -->
            <input type="hidden" id="gameIdInput" name="gameId">
            <input type="hidden" id="groundIdInput" name="groundId">
            <input type="hidden" id="slotIdInput" name="slotId">

            <!-- Select City -->
            <div class="mb-3">
                <label for="citySelect" class="form-label">Select City</label>
                <select id="citySelect" class="form-select">
                    <option value="">Select City</option>
                    <option th:each="city : ${uniqueCities}" th:value="${city}" th:text="${city}"></option>
                </select>
            </div>

            <!-- Select Game -->
            <div class="mb-3">
                <label for="gameSelect" class="form-label">Select Game</label>
                <select id="gameSelect" class="form-select" name="gameId">
                    <option value="">Select Game</option>
                    <option th:each="game : ${games}" th:value="${game.id}" th:text="${game.gameName}"></option>
                </select>
            </div>
            
            <!-- Select Ground -->
            <div class="mb-3">
                <label for="groundSelect" class="form-label">Select Ground</label>
                <select id="groundSelect" class="form-select">
                    <option value="">Select Ground</option>
                    <option th:each="ground : ${grounds}" 
                            th:value="${ground.id}"  
                            th:text="${ground.name}">
                    </option>
                </select>
            </div>
            
            <div id="slotContainer" class="slot-container">
                <!-- Slots will be added dynamically -->
            </div>
            
            <button type="submit" class="btn btn-primary">Book Now</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            $("#citySelect").change(function () {
                var selectedCity = $(this).val();
                if (selectedCity) {
                    $.ajax({
                        type: "GET",
                        url: "/getGamesByCity",
                        data: { city: selectedCity },
                        success: function (games) {
                            $("#gameSelect").empty().append('<option value="">Select Game</option>');
                            $.each(games, function (index, game) {
                                $("#gameSelect").append('<option value="' + game + '">' + game + '</option>');
                            });
                            $("#groundSelect").empty().append('<option value="">Select Ground</option>'); // Reset grounds
                        }
                    });
                } else {
                    $("#gameSelect").empty().append('<option value="">Select Game</option>');
                    $("#groundSelect").empty().append('<option value="">Select Ground</option>');
                }
            });

			$("#gameSelect").change(function () {
			    var selectedCity = $("#citySelect").val();
			    var selectedGame = $(this).val(); // Get game name instead of ID

			    if (selectedCity && selectedGame) {
			        $.ajax({
			            type: "GET",
			            url: "/getGroundsByCityAndGame",
			            data: { city: selectedCity, game: selectedGame }, // Send game name
			            success: function (grounds) {
			                $("#groundSelect").empty().append('<option value="">Select Ground</option>');
			                $.each(grounds, function (index, ground) {
			                    $("#groundSelect").append('<option value="' + ground.id + '">' + ground.name + '</option>');
			                });
			            }
			        });
			    } else {
			        $("#groundSelect").empty().append('<option value="">Select Ground</option>');
			    }
			});

            $("#groundSelect").change(function () {
                let selectedGroundId = $(this).val();

                if (selectedGroundId) {
                    fetchSlots(selectedGroundId);
                }
            });

            function displaySlots(slots) {
                let slotContainer = $("#slotContainer");
                slotContainer.empty();

                if (slots.length === 0) {
                    slotContainer.append('<p>No slots available for this ground.</p>');
                    return;
                }

                slots.forEach(slot => {
                    let slotCard = `
                        <div class="slot-card">
                            <p><strong>Time:</strong> ${slot.startTime} - ${slot.endTime}</p>
                            <p><strong>Price:</strong> ₹${slot.price} (Weekend: ₹${slot.weekendPrice})</p>
                            <p><strong>Availability:</strong> ${slot.availability}</p>
                            <p><strong>Break Time:</strong> ${slot.breakTime}</p>
                            <button class="btn btn-success book-slot" data-slot-id="${slot.id}">Book</button>
                        </div>
                    `;
                    slotContainer.append(slotCard);
                });

                // Attach click event to dynamically generated buttons
                $(".book-slot").click(function () {
                    let slotId = $(this).data("slot-id");
                    let groundId = $("#groundSelect").val();
                    let gameId = $("#gameSelect").val();

                    if (!groundId || !gameId || !slotId) {
                        alert("Please select a valid game, ground, and slot.");
                        return;
                    }

                    // Set hidden input values
                    $("#gameIdInput").val(gameId);
                    $("#groundIdInput").val(groundId);
                    $("#slotIdInput").val(slotId);

                    // Submit form
                    $("#bookingForm").submit();
                });
            }

            function fetchSlots(groundId) {
                $.ajax({
                    url: "/getSlotsByGround",
                    type: "GET",
                     data: JSON.stringify({ gameId: gameId, groundId: groundId, slotId: slotId }),
                    success: function (response) {
                        displaySlots(response);
                    },
                    error: function (error) {
                        console.error("Error fetching slots:", error);
                    }
                });
            }
        });
    </script>

</body>
</html>
